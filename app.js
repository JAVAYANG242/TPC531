// Âè∞ÈõªÁôºÈõªÊï∏ÊìöÁõ£Êéß - ÂÆåÊï¥ÁâàÊú¨
class TaipowerMonitor {
    constructor() {
        this.apiUrl = 'https://www.taipower.com.tw/d006/loadGraph/loadGraph/data/genary.json';
        this.proxyServices = [
            {
                name: 'AllOrigins',
                url: 'https://api.allorigins.win/get?url=',
                parser: 'allorigins'
            },
            {
                name: 'CorsProxy.io',
                url: 'https://corsproxy.io/?',
                parser: 'direct'
            },
            {
                name: 'Proxy-CorsAnywhere',
                url: 'https://cors-anywhere.herokuapp.com/',
                parser: 'direct'
            },
            {
                name: 'ThingProxy',
                url: 'https://thingproxy.freeboard.io/fetch/',
                parser: 'direct'
            }
        ];
        
        // Êï∏ÊìöË®òÈåÑ
        this.dayData = this.loadHistoryData('dayData') || [];     // Êó•ÈñìÊï∏Êìö (6:00-18:00)
        this.nightData = this.loadHistoryData('nightData') || []; // Â§úÈñìÊï∏Êìö (18:00-6:00)
        
        // ËºâÂÖ•Ê≠∑Âè≤Êï∏Êìö
        this.loadInitialHistoricalData();
        
        // ÊôÇÈñìÂçÄÈñìË®≠ÁΩÆ
        this.currentTimeRange = '24h';  // È†êË®≠24Â∞èÊôÇ
        this.timeRanges = {
            '1h': { hours: 1, label: 'ÊúÄËøë‰∏ÄÂ∞èÊôÇ' },
            '24h': { hours: 24, label: 'ÊúÄËøë‰∏ÄÂ§©' },
            '7d': { hours: 168, label: 'ÊúÄËøë‰∏ÄÂë®' },
            '30d': { hours: 720, label: 'ÊúÄËøë‰∏ÄÂÄãÊúà' }
        };
        
        // ÂúñË°®
        this.dayChart = null;
        this.nightChart = null;
        this.pieChart = null;
        
        this.init();
    }

    loadInitialHistoricalData() {
        // Â¶ÇÊûúÊúâÂ§ñÈÉ®Ê≠∑Âè≤Êï∏ÊìöÔºåËºâÂÖ•ÂÆÉÂÄë
        if (typeof loadHistoricalData === 'function') {
            try {
                const historicalData = loadHistoricalData();
                if (historicalData && historicalData.dayHistoryData && historicalData.nightHistoryData) {
                    // ËΩâÊèõÊ†ºÂºè‰ª•Á¨¶ÂêàÂÖßÈÉ®Êï∏ÊìöÁµêÊßã
                    const convertData = (data) => data.map(item => ({
                        time: item.time,
                        percentage: item.thermalPercent,
                        timestamp: new Date(item.time).getTime()
                    }));
                    
                    // Âè™ÊúâÁï∂Êú¨Âú∞Ê≤íÊúâÊï∏ÊìöÊôÇÊâçËºâÂÖ•Ê≠∑Âè≤Êï∏Êìö
                    if (this.dayData.length === 0) {
                        this.dayData = convertData(historicalData.dayHistoryData);
                        this.saveHistoryData('dayData', this.dayData);
                        console.log(`üìö ËºâÂÖ•Ê≠∑Âè≤Êó•ÈñìÊï∏Êìö: ${this.dayData.length} Á≠Ü`);
                    }
                    
                    if (this.nightData.length === 0) {
                        this.nightData = convertData(historicalData.nightHistoryData);
                        this.saveHistoryData('nightData', this.nightData);
                        console.log(`üìö ËºâÂÖ•Ê≠∑Âè≤Â§úÈñìÊï∏Êìö: ${this.nightData.length} Á≠Ü`);
                    }
                }
            } catch (e) {
                console.warn('ËºâÂÖ•Ê≠∑Âè≤Êï∏ÊìöÊôÇÁôºÁîüÈåØË™§:', e);
            }
        }
    }

    init() {
        console.log('üìä Âè∞ÈõªÁôºÈõªÊï∏ÊìöÁõ£ÊéßÁ≥ªÁµ±ÂïüÂãï');
        this.updateStatus('connecting', 'ÈÄ£Êé•‰∏≠...');
        this.setupCharts();
        this.setupTimeRangeButtons();
        this.fetchData();
        
        // ÊØè10ÂàÜÈêòÊõ¥Êñ∞‰∏ÄÊ¨°
        setInterval(() => {
            this.fetchData();
        }, 600000); // 10ÂàÜÈêò = 600,000ÊØ´Áßí
        
        console.log('‚è∞ Ë®≠ÂÆöÊØè10ÂàÜÈêòËá™ÂãïÊõ¥Êñ∞Êï∏Êìö');
    }

    setupCharts() {
        // ÁôºÈõªÁµêÊßãÈ§ÖÂúñ
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        this.pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['ÁÅ´ÂäõÁôºÈõª', 'ÂÜçÁîüËÉΩÊ∫ê', 'ÂÑ≤ËÉΩ'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: [
                        '#e74c3c',  // ÁÅ´ÂäõÁôºÈõª - Á¥ÖËâ≤
                        '#27ae60',  // ÂÜçÁîüËÉΩÊ∫ê - Á∂†Ëâ≤
                        '#f39c12'   // ÂÑ≤ËÉΩ - Ê©ôËâ≤
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    hoverBorderWidth: 4,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14
                            },
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value.toLocaleString()} MW (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    duration: 1000
                }
            }
        });

        // Êó•ÈñìÁÅ´ÂäõÂç†ÊØîÂúñË°®
        const dayCtx = document.getElementById('dayChart').getContext('2d');
        this.dayChart = new Chart(dayCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'ÁÅ´ÂäõÁôºÈõªÂç†ÊØî (%)',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        display: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        title: {
                            display: true,
                            text: 'ÊôÇÈñì'
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });

        // Â§úÈñìÁÅ´ÂäõÂç†ÊØîÂúñË°®
        const nightCtx = document.getElementById('nightChart').getContext('2d');
        this.nightChart = new Chart(nightCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'ÁÅ´ÂäõÁôºÈõªÂç†ÊØî (%)',
                    data: [],
                    borderColor: '#9b59b6',
                    backgroundColor: 'rgba(155, 89, 182, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        display: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        title: {
                            display: true,
                            text: 'ÊôÇÈñì'
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });

        // ËºâÂÖ•Ê≠∑Âè≤Êï∏ÊìöÂà∞ÂúñË°®
        this.updateCharts();
    }

    updateStatus(type, message) {
        const statusElement = document.getElementById('status');
        statusElement.className = `status ${type}`;
        statusElement.textContent = message;
    }

    async fetchData() {
        this.updateStatus('connecting', 'Áç≤ÂèñÊï∏Êìö‰∏≠...');
        
        // ‰æùÂ∫èÂòóË©¶ÊâÄÊúâ‰ª£ÁêÜÊúçÂãô
        for (let i = 0; i < this.proxyServices.length; i++) {
            const proxy = this.proxyServices[i];
            console.log(`üîå ÂòóË©¶‰ª£ÁêÜÊúçÂãô: ${proxy.name} (${i + 1}/${this.proxyServices.length})`);
            
            try {
                const success = await this.tryProxy(proxy);
                if (success) {
                    console.log(`‚úÖ ÊàêÂäüÔºÅÈÄèÈÅé ${proxy.name} Áç≤ÂèñÂè∞ÈõªÊï∏Êìö`);
                    this.updateStatus('success', 'ÈÄ£Êé•ÊàêÂäü');
                    return;
                }
            } catch (error) {
                console.warn(`‚ùå ${proxy.name} Â§±Êïó:`, error.message);
                continue;
            }
        }
        
        // ÊâÄÊúâ‰ª£ÁêÜÈÉΩÂ§±Êïó
        console.error('üö´ ÊâÄÊúâ‰ª£ÁêÜÊúçÂãôÈÉΩÁÑ°Ê≥ïÁç≤ÂèñÂè∞ÈõªÊï∏Êìö');
        this.showCorsError();
    }

    async tryProxy(proxy) {
        const proxyUrl = proxy.url + encodeURIComponent(this.apiUrl);
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ÁßíË∂ÖÊôÇ
            
            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            let powerData;
            
            if (proxy.parser === 'allorigins') {
                const proxyResponse = await response.json();
                if (proxyResponse.status && proxyResponse.status.http_code === 200) {
                    powerData = JSON.parse(proxyResponse.contents);
                } else {
                    throw new Error(`‰ª£ÁêÜÈåØË™§: ${proxyResponse.status?.http_code || 'Unknown'}`);
                }
            } else {
                powerData = await response.json();
            }
            
            // È©óË≠âÊï∏ÊìöÊ†ºÂºè
            if (!powerData || !powerData.aaData || !Array.isArray(powerData.aaData)) {
                throw new Error('Êï∏ÊìöÊ†ºÂºè‰∏çÊ≠£Á¢∫');
            }
            
            this.processData(powerData);
            return true;
            
        } catch (error) {
            if (error.name === 'AbortError') {
                throw new Error('Ë´ãÊ±ÇË∂ÖÊôÇ');
            }
            throw error;
        }
    }

    processData(rawData) {
        const updateTime = rawData[''] || new Date().toLocaleString('zh-TW');
        const aaData = rawData.aaData || [];
        
        // ÂàÜÈ°ûÁµ±Ë®à
        const thermal = { nuclear: 0, coal: 0, lng: 0, oil: 0, cogen: 0 };
        const renewable = { solar: 0, wind: 0, hydro: 0, other: 0 };
        const storage = { discharge: 0, charge: 0 };

        aaData.forEach(item => {
            const powerType = item[0] || '';
            const subType = item[1] || '';
            const unitName = item[2] || '';
            const generation = parseFloat(item[4]) || 0;

            // Ë∑≥ÈÅéÂ∞èË®àË°å
            if (unitName.includes('Â∞èË®à')) {
                return;
            }

            // ÁÅ´ÂäõÁôºÈõªÂàÜÈ°û - Ê†πÊìöÂè∞ÈõªÂØ¶ÈöõÂàÜÈ°û
            if (powerType.includes('Ê†∏ËÉΩ') || powerType.includes('Nuclear')) {
                thermal.nuclear += generation;
            } 
            else if (powerType.includes('ÁáÉÁÖ§') || powerType.includes('Coal')) {
                thermal.coal += generation;
            }
            else if (powerType.includes('Ê∞ëÁáüÈõªÂª†-ÁáÉÁÖ§') || powerType.includes('IPP-Coal')) {
                thermal.coal += generation; // Ê∞ëÁáüÁáÉÁÖ§‰ΩµÂÖ•ÁáÉÁÖ§
            }
            else if (powerType.includes('ÁáÉÊ∞£') || powerType.includes('LNG')) {
                thermal.lng += generation;
            }
            else if (powerType.includes('Ê∞ëÁáüÈõªÂª†-ÁáÉÊ∞£') || powerType.includes('IPP-LNG')) {
                thermal.lng += generation; // Ê∞ëÁáüÁáÉÊ∞£‰ΩµÂÖ•ÁáÉÊ∞£
            }
            else if (powerType.includes('ÁáÉÊ≤π') || powerType.includes('Oil')) {
                thermal.oil += generation;
            }
            else if (powerType.includes('ËºïÊ≤π') || powerType.includes('Diesel')) {
                thermal.oil += generation; // ËºïÊ≤π‰ΩµÂÖ•ÁáÉÊ≤π
            }
            else if (powerType.includes('Ê±ΩÈõªÂÖ±Áîü') || powerType.includes('Co-Gen')) {
                thermal.cogen += generation;
            }
            // ÂÜçÁîüËÉΩÊ∫êÂàÜÈ°û
            else if (powerType.includes('Â§™ÈôΩËÉΩ') || powerType.includes('Solar')) {
                renewable.solar += generation;
            } 
            else if (powerType.includes('È¢®Âäõ') || powerType.includes('Wind')) {
                renewable.wind += generation;
            } 
            else if (powerType.includes('Ê∞¥Âäõ') || powerType.includes('Hydro')) {
                // ÊéíÈô§ÊäΩËìÑÊ∞¥ÂäõÔºàÈÇ£ÊòØÂÑ≤ËÉΩÔºâ
                if (!subType.includes('ÊäΩËìÑÊ∞¥Âäõ') && !subType.includes('Pumped Hydro')) {
                    renewable.hydro += generation;
                }
            } 
            else if (powerType.includes('ÂÖ∂ÂÆÉÂÜçÁîüËÉΩÊ∫ê') || powerType.includes('Other Renewable')) {
                renewable.other += generation;
            }
            // ÂÑ≤ËÉΩÁ≥ªÁµ±ÂàÜÈ°û
            else if (powerType.includes('ÂÑ≤ËÉΩ') && powerType.includes('Energy Storage')) {
                storage.discharge += generation;
            }
            else if (powerType.includes('ÂÑ≤ËÉΩË≤†Ëºâ') && powerType.includes('Energy Storage Load')) {
                storage.charge += generation;
            }
        });

        // Ë®àÁÆóÁ∏ΩË®à
        const thermalTotal = thermal.nuclear + thermal.coal + thermal.lng + thermal.oil + thermal.cogen;
        const renewableTotal = renewable.solar + renewable.wind + renewable.hydro + renewable.other;
        const storageNet = storage.discharge - storage.charge;
        const totalPower = thermalTotal + renewableTotal + storageNet;

        // Ë®àÁÆóÂç†ÊØî
        const thermalPercent = totalPower > 0 ? ((thermalTotal / totalPower) * 100).toFixed(1) : 0;
        const renewablePercent = totalPower > 0 ? ((renewableTotal / totalPower) * 100).toFixed(1) : 0;
        const storagePercent = totalPower > 0 ? ((Math.abs(storageNet) / totalPower) * 100).toFixed(1) : 0;

        // Êõ¥Êñ∞È°ØÁ§∫
        this.updateDisplay({
            updateTime,
            thermal: { ...thermal, total: thermalTotal },
            renewable: { ...renewable, total: renewableTotal },
            storage: { net: storageNet, status: storageNet > 0 ? 'ÊîæÈõª‰∏≠' : 'ÂÖÖÈõª‰∏≠' },
            total: totalPower,
            percentages: { thermal: thermalPercent, renewable: renewablePercent, storage: storagePercent }
        });

        // Ë®òÈåÑÊï∏ÊìöÁî®ÊñºÂúñË°®
        this.recordData(thermalPercent, updateTime);

        // Ë©≥Á¥∞Êó•Ë™åËº∏Âá∫
        console.log('üìä Âè∞ÈõªÊï∏ÊìöËß£ÊûêÂÆåÊàê (ÊôÇÈñì: ' + updateTime + ')');
        console.log('üî• ÁÅ´ÂäõÁôºÈõªË©≥Á¥∞:');
        console.log('   Ê†∏ËÉΩ: ' + Math.round(thermal.nuclear) + ' MW');
        console.log('   ÁáÉÁÖ§(Âê´Ê∞ëÁáü): ' + Math.round(thermal.coal) + ' MW');
        console.log('   ÁáÉÊ∞£(Âê´Ê∞ëÁáü): ' + Math.round(thermal.lng) + ' MW');
        console.log('   ÁáÉÊ≤π+ËºïÊ≤π: ' + Math.round(thermal.oil) + ' MW');
        console.log('   Ê±ΩÈõªÂÖ±Áîü: ' + Math.round(thermal.cogen) + ' MW');
        console.log('   ÁÅ´ÂäõÂ∞èË®à: ' + Math.round(thermalTotal) + ' MW (' + thermalPercent + '%)');
        console.log('üå± ÂÜçÁîüËÉΩÊ∫êË©≥Á¥∞:');
        console.log('   Â§™ÈôΩËÉΩ: ' + Math.round(renewable.solar) + ' MW');
        console.log('   È¢®Âäõ: ' + Math.round(renewable.wind) + ' MW');
        console.log('   Ê∞¥Âäõ: ' + Math.round(renewable.hydro) + ' MW');
        console.log('   ÂÖ∂‰ªñÂÜçÁîü: ' + Math.round(renewable.other) + ' MW');
        console.log('   ÂÜçÁîüÂ∞èË®à: ' + Math.round(renewableTotal) + ' MW (' + renewablePercent + '%)');
        console.log('üîã ÂÑ≤ËÉΩÁ≥ªÁµ±: ' + Math.round(storageNet) + ' MW (' + storagePercent + '% - ' + (storageNet > 0 ? 'ÊîæÈõª' : 'ÂÖÖÈõª') + ')');
        console.log('‚ö° Á∏ΩÁôºÈõªÈáè: ' + Math.round(totalPower) + ' MW');
        console.log('üåê Ë´ãÊØîÂ∞çÂè∞ÈõªÂÆòÁ∂≤: https://www.taipower.com.tw/d006/loadGraph/loadGraph/genshx_.html');
    }

    recordData(thermalPercent, updateTime) {
        const now = new Date();
        const hour = now.getHours();
        
        const dataPoint = {
            time: updateTime || now.toLocaleString('zh-TW'), // ‰ΩøÁî®ÂÆåÊï¥ÁöÑÊó•ÊúüÊôÇÈñì
            percentage: parseFloat(thermalPercent),
            timestamp: now.getTime()
        };

        // Âà§Êñ∑Êó•ÈñìÊàñÂ§úÈñì (Êó•Èñì: 6:00-18:00, Â§úÈñì: 18:00-6:00)
        if (hour >= 6 && hour < 18) {
            // Êó•ÈñìÊï∏Êìö
            this.dayData.push(dataPoint);
            console.log(`‚òÄÔ∏è Ë®òÈåÑÊó•ÈñìÊï∏Êìö: ${dataPoint.time} - ${thermalPercent}%`);
        } else {
            // Â§úÈñìÊï∏Êìö
            this.nightData.push(dataPoint);
            console.log(`üåô Ë®òÈåÑÂ§úÈñìÊï∏Êìö: ${dataPoint.time} - ${thermalPercent}%`);
        }

        // ‰øùÊåÅÊúÄËøë50Á≠ÜË®òÈåÑ
        if (this.dayData.length > 50) {
            this.dayData = this.dayData.slice(-50);
        }
        if (this.nightData.length > 50) {
            this.nightData = this.nightData.slice(-50);
        }

        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÑ≤
        this.saveHistoryData('dayData', this.dayData);
        this.saveHistoryData('nightData', this.nightData);

        // Êõ¥Êñ∞ÂúñË°®
        this.updateCharts();
        
        // Ëá™Âãï‰øùÂ≠òÁï∂ÂâçÊï∏ÊìöÂà∞Êú¨Âú∞Â≠òÂÑ≤
        this.saveToLocalStorage();
        
        console.log('‚úÖ Êï∏ÊìöÈ°ØÁ§∫Êõ¥Êñ∞ÂÆåÊàê');
    }

    updateCharts() {
        // Ê†πÊìöÊôÇÈñìÂçÄÈñìÊ±∫ÂÆöÊôÇÈñìÊ†ºÂºè
        const formatTimeLabel = (dataPoint) => {
            if (!dataPoint.time && !dataPoint.timestamp) return '';
            
            let date;
            if (dataPoint.timestamp) {
                date = new Date(dataPoint.timestamp);
            } else {
                // ÂòóË©¶Ëß£ÊûêÊôÇÈñìÂ≠óÁ¨¶‰∏≤
                const timeStr = dataPoint.time;
                if (timeStr.includes('-')) {
                    // ÂÆåÊï¥Êó•ÊúüÊ†ºÂºè
                    date = new Date(timeStr);
                } else {
                    // ÂÉÖÊôÇÈñìÊ†ºÂºèÔºåÂÅáË®≠ÊòØ‰ªäÂ§©
                    const today = new Date();
                    const [hours, minutes] = timeStr.split(':');
                    date = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
                }
            }
            
            if (isNaN(date.getTime())) return dataPoint.time || '';
            
            // Ê†πÊìöÊôÇÈñìÂçÄÈñìÈÅ∏ÊìáÊ†ºÂºè
            switch (this.currentTimeRange) {
                case '1h':
                case '24h':
                    return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                case '7d':
                    return date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }) + ' ' +
                           date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                case '30d':
                    return date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
                default:
                    return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            }
        };

        // Êõ¥Êñ∞Êó•ÈñìÂúñË°®
        this.dayChart.data.labels = this.dayData.map(formatTimeLabel);
        this.dayChart.data.datasets[0].data = this.dayData.map(d => d.percentage);
        this.dayChart.update('none');

        // Êõ¥Êñ∞Â§úÈñìÂúñË°®
        this.nightChart.data.labels = this.nightData.map(formatTimeLabel);
        this.nightChart.data.datasets[0].data = this.nightData.map(d => d.percentage);
        this.nightChart.update('none');
    }

    updateDisplay(data) {
        // Êõ¥Êñ∞ÊôÇÈñì
        document.getElementById('lastUpdate').textContent = data.updateTime;

        // Êõ¥Êñ∞‰∏ªË¶ÅÊï∏Êìö
        document.getElementById('totalPower').textContent = this.formatNumber(data.total) + ' MW';
        document.getElementById('thermalPower').textContent = this.formatNumber(data.thermal.total) + ' MW';
        document.getElementById('thermalPercent').textContent = data.percentages.thermal + '%';
        document.getElementById('renewablePower').textContent = this.formatNumber(data.renewable.total) + ' MW';
        document.getElementById('renewablePercent').textContent = data.percentages.renewable + '%';
        document.getElementById('storagePower').textContent = this.formatNumber(Math.abs(data.storage.net)) + ' MW';
        document.getElementById('storagePercent').textContent = data.percentages.storage + '%';
        document.getElementById('storageStatus').textContent = data.storage.status;

        // Êõ¥Êñ∞ÁÅ´ÂäõÁôºÈõªÊòéÁ¥∞
        document.getElementById('nuclear').textContent = this.formatNumber(data.thermal.nuclear) + ' MW';
        document.getElementById('coal').textContent = this.formatNumber(data.thermal.coal) + ' MW';
        document.getElementById('lng').textContent = this.formatNumber(data.thermal.lng) + ' MW';
        document.getElementById('oil').textContent = this.formatNumber(data.thermal.oil) + ' MW';
        document.getElementById('cogen').textContent = this.formatNumber(data.thermal.cogen) + ' MW';

        // Êõ¥Êñ∞ÂÜçÁîüËÉΩÊ∫êÊòéÁ¥∞
        document.getElementById('solar').textContent = this.formatNumber(data.renewable.solar) + ' MW';
        document.getElementById('wind').textContent = this.formatNumber(data.renewable.wind) + ' MW';
        document.getElementById('hydro').textContent = this.formatNumber(data.renewable.hydro) + ' MW';
        document.getElementById('otherRenewable').textContent = this.formatNumber(data.renewable.other) + ' MW';

        // Êõ¥Êñ∞È§ÖÂúñ
        this.pieChart.data.datasets[0].data = [
            data.thermal.total,
            data.renewable.total,
            Math.abs(data.storage.net)
        ];
        this.pieChart.update('active');

        // Èö±ËóèÈåØË™§‰ø°ÊÅØ
        document.getElementById('errorMessage').style.display = 'none';
    }

    formatNumber(num) {
        return Math.round(num).toLocaleString();
    }

    loadHistoryData(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        } catch (error) {
            console.error('ËºâÂÖ•Ê≠∑Âè≤Êï∏ÊìöÊôÇÁôºÁîüÈåØË™§:', error);
            return [];
        }
    }

    saveHistoryData(key, data) {
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (error) {
            console.error('‰øùÂ≠òÊ≠∑Âè≤Êï∏ÊìöÊôÇÁôºÁîüÈåØË™§:', error);
        }
    }

    showCorsError() {
        document.getElementById('errorMessage').style.display = 'block';
        this.updateStatus('error', 'ÈÄ£Êé•Â§±Êïó');
    }
    
    setupTimeRangeButtons() {
        /**Ë®≠ÁΩÆÊôÇÈñìÂçÄÈñìÈÅ∏ÊìáÊåâÈàï**/
        const buttons = document.querySelectorAll('.time-btn');
        
        buttons.forEach((button, index) => {
            const ranges = ['1h', '24h', '7d', '30d'];
            const range = ranges[index];
            
            button.addEventListener('click', () => {
                // ÁßªÈô§ÊâÄÊúâactiveÈ°ûÂà•
                buttons.forEach(btn => btn.classList.remove('active'));
                // Ê∑ªÂä†activeÂà∞Áï∂ÂâçÊåâÈàï
                button.classList.add('active');
                
                // Êõ¥Êñ∞ÊôÇÈñìÂçÄÈñì
                this.currentTimeRange = range;
                console.log(`üïí ÂàáÊèõÂà∞ÊôÇÈñìÂçÄÈñì: ${this.timeRanges[range].label}`);
                
                // ÈáçÊñ∞ËºâÂÖ•Ê≠∑Âè≤Êï∏Êìö‰∏¶Êõ¥Êñ∞ÂúñË°®
                this.loadHistoricalDataFromStorage();
                this.updateCharts();
            });
        });
        
        console.log('‚öôÔ∏è ÊôÇÈñìÂçÄÈñìÊåâÈàïÂ∑≤Ë®≠ÁΩÆ');
    }
    
    filterDataByTimeRange(data) {
        /**Ê†πÊìöÊôÇÈñìÂçÄÈñìÈÅéÊøæÊï∏Êìö**/
        if (!data || data.length === 0) return data;
        
        const hours = this.timeRanges[this.currentTimeRange].hours;
        const cutoffTime = new Date(Date.now() - hours * 60 * 60 * 1000);
        
        return data.filter(item => {
            try {
                const itemTime = new Date(item.time);
                return itemTime >= cutoffTime;
            } catch (e) {
                return false;
            }
        });
    }
    
    loadHistoricalDataFromStorage() {
        /**ÂæûÊú¨Âú∞Â≠òÂÑ≤ËºâÂÖ•Ê≠∑Âè≤Êï∏Êìö‰∏¶ÊáâÁî®ÊôÇÈñìÈÅéÊøæ**/
        try {
            // ËºâÂÖ•ÂÆåÊï¥ÁöÑÊ≠∑Âè≤Êï∏Êìö
            const fullDayData = this.loadHistoryData('dayData') || [];
            const fullNightData = this.loadHistoryData('nightData') || [];
            
            // Ê†πÊìöÊôÇÈñìÂçÄÈñìÈÅéÊøæ
            this.dayData = this.filterDataByTimeRange(fullDayData);
            this.nightData = this.filterDataByTimeRange(fullNightData);
            
            console.log(`üìä ËºâÂÖ•Ê≠∑Âè≤Êï∏Êìö - ${this.timeRanges[this.currentTimeRange].label}`);
            console.log(`   Êó•Èñì: ${this.dayData.length} Á≠Ü`);
            console.log(`   Â§úÈñì: ${this.nightData.length} Á≠Ü`);
            
        } catch (e) {
            console.error('ËºâÂÖ•Ê≠∑Âè≤Êï∏ÊìöÈåØË™§:', e);
        }
    }
    
    saveToLocalStorage() {
        /**‰øùÂ≠òÁï∂ÂâçÊï∏ÊìöÂà∞Êú¨Âú∞Â≠òÂÑ≤**/
        try {
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace('T', ' ');
            
            // ÂæûlocalStorageÁç≤ÂèñÂÆåÊï¥Êï∏Êìö
            let fullDayData = this.loadHistoryData('dayData') || [];
            let fullNightData = this.loadHistoryData('nightData') || [];
            
            // Ê∑ªÂä†Áï∂ÂâçÊï∏ÊìöÈªûÔºàÂ¶ÇÊûúÊúâÊñ∞ÁöÑÁÅ´ÂäõÂç†ÊØîÊï∏ÊìöÔºâ
            const currentData = this.getCurrentThermalData();
            if (currentData) {
                const dataPoint = {
                    time: timestamp,
                    thermalPercent: currentData.thermalPercent
                };
                
                const hour = now.getHours();
                if (6 <= hour && hour < 18) {
                    fullDayData.push(dataPoint);
                    // ‰øùÊåÅÊúÄËøë1000Á≠ÜË®òÈåÑ
                    if (fullDayData.length > 1000) {
                        fullDayData = fullDayData.slice(-1000);
                    }
                } else {
                    fullNightData.push(dataPoint);
                    if (fullNightData.length > 1000) {
                        fullNightData = fullNightData.slice(-1000);
                    }
                }
                
                // ‰øùÂ≠òÂà∞localStorage
                this.saveHistoryData('dayData', fullDayData);
                this.saveHistoryData('nightData', fullNightData);
                
                console.log('üíæ Êï∏ÊìöÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÑ≤');
            }
            
        } catch (e) {
            console.error('‰øùÂ≠òÊï∏ÊìöÈåØË™§:', e);
        }
    }
    
    getCurrentThermalData() {
        /**Áç≤ÂèñÁï∂ÂâçÁÅ´ÂäõÁôºÈõªÊï∏Êìö**/
        try {
            const thermalElement = document.getElementById('thermalPercent');
            if (thermalElement && thermalElement.textContent !== '-- %') {
                const percentText = thermalElement.textContent.replace('%', '').trim();
                const thermalPercent = parseFloat(percentText);
                if (!isNaN(thermalPercent)) {
                    return { thermalPercent };
                }
            }
            return null;
        } catch (e) {
            return null;
        }
    }
}

// È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂïüÂãïÁ≥ªÁµ±
document.addEventListener('DOMContentLoaded', () => {
    window.taipowerMonitor = new TaipowerMonitor();
}); 